<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>奇点科普科幻投稿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <style>
        body { background: #f0f2f5; }
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .guide, .card-section { padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        .tag { display: inline-flex; align-items: center; margin: 3px; padding: 4px 8px; background: #51aded; color: #fff; border-radius: 5px; font-size: 0.9rem; }
        .tag .remove { margin-left: 6px; cursor: pointer; font-weight: bold; color: #fff; }
        .tag .remove:hover { color: #ffdddd; }
        .preview-img { max-width: 120px; margin: 5px; display: inline-block; text-align: center; background: #f8f9fa; padding: 5px; border-radius: 5px; }
        .preview-img img { max-width: 100%; border-radius: 4px; }
        .img-btns { display: flex; justify-content: space-between; margin-top: 5px; }
        .email-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .email-group input { flex: 1; }
        .btn-sm { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
    </style>
</head>
<body class="container my-4">

<h2 class="mb-3 text-center">奇点科普科幻投稿</h2>
<div id="app"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

<script type="text/babel">
    const backend_url = "https://contribute.qidian.space"
    const { useState, useEffect, useRef } = React;

    function App() {
        const [title, setTitle] = useState("");
        const [author, setAuthor] = useState("");
        const [email, setEmail] = useState("");
        const [emailCode, setEmailCode] = useState("");
        const [tags, setTags] = useState([]);
        const [cover, setCover] = useState(null);
        const [images, setImages] = useState([]);
        const editorRef = useRef(null);

        useEffect(() => {
            const editor = new toastui.Editor({
                el: document.getElementById('editor'),
                height: '400px',
                initialEditType: 'markdown',
                previewStyle: 'vertical',
                initialValue: '# 请输入正文'
            });
            editorRef.current = editor;
        }, []);

        // 文件转 base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(",")[1]); // 去掉 data:image/...;base64,
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function toWebp(file) {
            const options = { fileType: "image/webp", maxWidthOrHeight: 1920, initialQuality: 0.8 };
            return await imageCompression(file, options);
        }

        async function handleCoverChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            const webpFile = await toWebp(file);
            const base64 = await fileToBase64(webpFile);
            setCover({ name: "cover.webp", base64 });
        }

        async function handleImagesChange(e) {
            const files = Array.from(e.target.files);
            const result = [];

            // 已有图片数量，继续往后排
            let startIndex = images.length + 1;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const webpFile = await toWebp(file);
                const base64 = await fileToBase64(webpFile);
                const name = `${startIndex + i}.webp`; // 用序号命名
                result.push({ name, base64 });
            }

            // 合并后，重新按名字中的数字排序
            const newImages = [...images, ...result].sort((a, b) => {
                const numA = parseInt(a.name);
                const numB = parseInt(b.name);
                return numA - numB;
            });

            setImages(newImages);
        }

        function insertImage(name) {
            const path = `./posts/${title || "未命名文章"}/${name}`;
            editorRef.current.insertText(`![${"请输入图注"}](${path})\n`);
        }

        function removeImage(name) {
            setImages(images.filter(img => img.name !== name));
        }

        function handleTagKeyDown(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const value = e.target.value.trim();
                if (value) {
                    setTags([...tags, value]);
                    e.target.value = "";
                }
            }
        }

        function removeTag(tag) {
            setTags(tags.filter(t => t !== tag));
        }

        async function sendEmailCode() {
            try {
                const res = await fetch(`${backend_url}/auth/send`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email }),
                });
                if (res.ok) {
                    alert("验证码已发送！");
                } else {
                    const text = await res.text();
                    alert("发送失败: " + text);
                }
            } catch (err) {
                console.error(err);
                alert("网络请求失败，请检查连接或稍后重试。");
            }
        }

        async function handleSubmit() {
            const content = editorRef.current.getMarkdown();
            const payload = {
                title,
                author,
                email,
                email_code: emailCode,  // 注意这里字段名要和后端 SubmissionRequest 对应
                tags,
                cover,
                images,
                content,
            };

            console.log(payload);

            try {
                const res = await fetch(`${backend_url}/submit`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload),
                });

                if (res.ok) {
                    alert("投稿成功！");
                    // 提交成功后可以清空表单
                    setTitle("");
                    setAuthor("");
                    setEmail("");
                    setEmailCode("");
                    setTags([]);
                    setCover(null);
                    setImages([]);
                    editorRef.current.setMarkdown("# 请输入正文");
                } else {
                    const text = await res.text();
                    alert("投稿失败: " + text);
                }
            } catch (err) {
                console.error(err);
                alert("网络请求失败，请检查连接或稍后重试。");
            }
        }

        return (
            <div>
                <div className="main-layout">
                    <div className="card-section">
                        <div className="mb-3">
                            <label className="form-label">文章标题</label>
                            <input type="text" className="form-control" value={title} onChange={e => setTitle(e.target.value)} />
                        </div>
                        <div className="mb-3">
                            <label className="form-label">作者名</label>
                            <input type="text" className="form-control" value={author} onChange={e => setAuthor(e.target.value)} />
                        </div>
                        <div className="mb-3">
                            <label className="form-label">作者邮箱</label>
                            <div className="email-group">
                                <input type="email" className="form-control" value={email} onChange={e => setEmail(e.target.value)} />
                                <button className="btn btn-outline-primary btn-sm" type="button" onClick={sendEmailCode}>发送验证码</button>
                                <input type="text" className="form-control" placeholder="验证码" value={emailCode} onChange={e => setEmailCode(e.target.value)} />
                                <button className="btn btn-outline-primary btn-sm" type="button" onClick={handleSubmit}>验证并提交</button>
                            </div>
                        </div>

                        <div className="mb-3">
                            <label className="form-label">标签</label>
                            <input type="text" className="form-control" placeholder="输入后回车添加" onKeyDown={handleTagKeyDown} />
                            <div className="mt-2">
                                {tags.map(tag => (
                                    <span key={tag} className="tag">
                                        {tag} <span className="remove" onClick={() => removeTag(tag)}>&times;</span>
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div className="mb-3">
                            <label className="form-label">封面图</label>
                            <input type="file" className="form-control" accept="image/*" onChange={handleCoverChange}/>
                            {cover && (
                                <div className="preview-img mt-2">
                                    <img src={`data:image/webp;base64,${cover.base64}`} alt="cover" /><br/>cover.webp
                                </div>
                            )}
                        </div>

                        <div className="mb-3">
                            <label className="form-label">文章插图</label>
                            <input type="file" className="form-control" accept="image/*" multiple onChange={handleImagesChange}/>
                            <div className="mt-2 d-flex flex-wrap">
                                {images.map(img => (
                                    <div key={img.name} className="preview-img">
                                        <img src={`data:image/webp;base64,${img.base64}`} alt={img.name}/>
                                        <div>{img.name}</div>
                                        <div className="img-btns">
                                            <button className="btn btn-outline-primary btn-sm" onClick={() => insertImage(img.name)}>插入</button>
                                            <button className="btn btn-outline-danger btn-sm" onClick={() => removeImage(img.name)}>删除</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="guide">
                        <h5>投稿指南</h5>
                        <div>
                            <strong>一、投稿前请确认</strong>
                            <ul>
                                <li>请务必在填写完所有内容后，再点击<strong>“发送验证码”</strong>与<strong>“验证并提交”</strong>提交投稿。</li>
                                <li>文章标题将用作系统内的文件夹名称，例如：<code>./posts/我的文章</code></li>
                            </ul>
                        </div>
                        <div>
                            <strong>二、图片处理与插入</strong>
                            <ul>
                                <li>所有上传图片将自动转换为 <code>WebP</code> 格式。</li>
                                <li>推荐：上传后点击“插入”按钮将图片添加到编辑器（预览区不显示属正常，不影响发布）。</li>
                                <li>可选：直接复制粘贴插入图片（Base64 格式，可预览，但性能较差，不推荐）。</li>
                            </ul>
                        </div>
                        <div>
                            <strong>三、投稿与后续</strong>
                            <ul>
                                <li>点击“投稿”后，系统需要约 <strong>20秒</strong> 进行处理，请耐心等待，切勿重复点击，以免造成重复提交。</li>
                                <li>投稿过程中如遇任何问题，请联系：<code>tsblydyzbjb@qidian.space</code></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div className="card-section">
                    <label className="form-label">正文</label>
                    <div id="editor"></div>
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById("app")).render(<App />);
</script>
